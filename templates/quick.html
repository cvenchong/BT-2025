<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>quick Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

</head>

<body>
  <!-- Customer ID Input Section -->
  <div style="margin: 20px;">
    <label for="customer-id">Customer ID:</label>
    <input type="text" id="customer-id" placeholder="Enter customer ID" style="padding: 8px; margin: 10px; width: 300px;" />
    <button id="init-paypal-btn" style="padding: 8px 20px; background-color: #0070ba; color: white; border: none; border-radius: 4px; cursor: pointer;">
      Initialize PayPal Button
    </button>
  </div>

  <!-- Set up a container element for the button -->
  <div id="paypal-button-container"></div>

  <script>
    // Initialize PayPal button when the init button is clicked
    document.getElementById('init-paypal-btn').addEventListener('click', async function() {
      const customerId = document.getElementById('customer-id').value;
      
      if (!customerId) {
        alert('Please enter a customer ID');
        return;
      }

      // Disable button during API call
      const initButton = this;
      initButton.disabled = true;
      initButton.textContent = 'Fetching Client Token...';

      try {
        // Fetch client token from PayPal OAuth endpoint
        const clientId = 'AUU0Jtg24SEu5dLLc9666tXHDn9jNa6jK3NzvciB6L2bdJdzsrtK0pVf8dBGXew356RgsuF96N9JwQGg';
        const clientSecret = 'EHVzVi_HdHuqMjQVYQQx7NF8klp7E4qrZA8GVvZSTvSZ5Vxc4lQ3Cu67Rr9OtPqvxyDC-7E5RcBXCsAj';
        const basicAuth = btoa(`${clientId}:${clientSecret}`);

        const response = await fetch('https://api-m.sandbox.paypal.com/v1/oauth2/token', {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${basicAuth}`,
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: new URLSearchParams({
            'grant_type': 'client_credentials',
            'response_type': 'id_token',
            'target_customer_id': customerId
          })
        });

        if (!response.ok) {
          const errorData = await response.text();
          throw new Error(`Failed to fetch token: ${response.status} - ${errorData}`);
        }

        const tokenData = await response.json();
        console.log('Token received:', tokenData);

        // Clear any existing PayPal buttons
        document.getElementById('paypal-button-container').innerHTML = '';

        // Update button text
        initButton.textContent = 'Loading PayPal SDK...';

        // Dynamically inject PayPal SDK script with the client ID and id_token
        const script = document.createElement('script');
        script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}`;
        script.setAttribute('data-user-id-token', tokenData.id_token);
        
        script.onload = function() {
          console.log('PayPal SDK loaded');
          
          // Render the eligible PayPal buttons within the #paypal-button-container
          paypal.Buttons({
            // You can use the customerId and tokenData here in your createOrder or other callbacks
            createOrder: function(data, actions) {
              console.log('Customer ID:', customerId);
              console.log('ID Token:', tokenData.id_token);
              console.log('Access Token:', tokenData.access_token);
              // Add your order creation logic here
              return actions.order.create({
                purchase_units: [{
                  amount: {
                    value: '10.00'
                  }
                }]
              });
            },
            onApprove: function(data, actions) {
              return actions.order.capture().then(function(details) {
                alert('Transaction completed by ' + details.payer.name.given_name);
                console.log('Transaction details:', details);
              });
            }
          }).render('#paypal-button-container');

          // Update button state after successful initialization
          initButton.textContent = 'PayPal Button Initialized';
          initButton.style.backgroundColor = '#28a745';
        };

        script.onerror = function() {
          throw new Error('Failed to load PayPal SDK');
        };

        document.head.appendChild(script);
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to initialize PayPal button: ' + error.message);
        
        // Re-enable button on error
        initButton.disabled = false;
        initButton.textContent = 'Initialize PayPal Button';
        initButton.style.backgroundColor = '#0070ba';
      }
    });
  </script>
</body>

</html>